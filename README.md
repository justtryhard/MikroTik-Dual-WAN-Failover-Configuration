# MikroTik-Dual-WAN-Failover-Configuration+Telegram-Notice

Данная конфигурация обеспечивает мгновенное переключение на резервного провайдера при аварии основного канала с уведомлениями в Telegram.

Собиралась под работу с двумя провайдерами: МГТС и Инетком. Провайдерский роутер МГТС остался на месте, ввиду чего 1 порт моего Микрота получает IP-адрес из его DHCP.
[ MGTS ] --> ether1 (Основной WAN, DHCP)
[ Inetcom ] --> ether2 (Резервный WAN, PPPoE)
[ Локальные устройства ] --> ether3-ether5 + WiFi (bridge1)

## Преимущества
- **Автоматическое переключение** при обрыве связи за 10-15 секунд
- **Двойной мониторинг** через ICMP к DNS-серверам (8.8.8.8 и 1.1.1.1)
- **Умное управление маршрутами** с приоритизацией каналов
- **Push-уведомления** в Telegram о статусе каналов
- **Готовое решение** для RouterOS v6

## Недостатки
- **Отсутствие обратной связи при одновременном падении двух каналов**. Однако, при наличии внешнего IP хотя бы у одного провайдера и сервера, который будет отправлять запросы на роутер, данный недостаток можно устранить.

<img width="1785" height="2157" alt="scheme" src="https://github.com/user-attachments/assets/5e55f8f0-803c-4b3a-9d5f-ec4813c65000" />

## Основные настройки

| Компонент          | Значение                                |
|--------------------|-----------------------------------------|
| **Основной WAN**   | ether1 (MGTS, DHCP-клиент)              |
| **Резервный WAN**  | ether2 (Inetcom, PPPoE)                 |
| **Локальная сеть** | bridge1 (192.168.88.1/24)               |
| **DHCP-сервер**    | 192.168.88.100-192.168.88.254           |
| **Мониторинг**     | Netwatch (интервал 5s, таймаут 2s)      |
| **DNS-серверы**    | 8.8.8.8, 1.1.1.1                        |

## Принцип работы переключения
1. **Основной канал (MGTS) доступен:**
   - Весь трафик идет через ether1
   - Маршрут "Main" имеет приоритет distance=1

2. **Обнаружение проблемы:**
   - Netwatch проверяет доступность 8.8.8.8 через основной канал и 1.1.1.1 через резервный канал каждые 5 секунд
   - При неудачной проверке Основого канала запускается скрипт переключения (с изменением стоимости маршрута). При удачной - скрипт возврата
   - Неудачная и удачная проверки Резервного канала лишь отправляют оповещение в Telegram

3. **Активация резерва:**
   ```bash
   /ip route set "Main" distance=3  # Снижение приоритета
   :delay 10s                       # Стабилизация соединения
   /system script run mgts_is_down  # Уведомление в Telegram
   ```
   Резервный маршрут "Backup" (distance=2) становится активным
   
4. **Восстановление основного канала:**
    ```bash
    /ip route set "Main" distance=1  # Возврат приоритета
    /system script run mgts_is_up    # Уведомление в Telegram
    ```
## Настройка Telegram-уведомлений
1. **Создать бота через @BotFather**

2. **Получить токен вида 123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11**

3. **Узнайть свой Chat ID через @userinfobot**

4. **Заменить в скриптах:**
  ```bash
  :local token "PLACE_YOUR_TOKEN_HERE"
  :local chat "PLACE_YOUR_CHATID_HERE"
  ```
